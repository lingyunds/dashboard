# å·¥ä½œæµçš„åç§°ï¼Œä¼šåœ¨GitHub Actionsé¡µé¢æ˜¾ç¤º
name: Django CI/CD Pipeline

# å®šä¹‰è§¦å‘æ¡ä»¶ï¼šä»€ä¹ˆæ—¶å€™è¿è¡Œè¿™ä¸ªå·¥ä½œæµ
on:
  # å½“ä»£ç æ¨é€åˆ°mainæˆ–developåˆ†æ”¯æ—¶è§¦å‘
  push:
    branches: [ main, develop ]
  # å½“æœ‰äººå‘mainåˆ†æ”¯åˆ›å»ºPull Requestæ—¶è§¦å‘
  pull_request:
    branches: [ main ]

# å®šä¹‰ç¯å¢ƒå˜é‡ï¼Œå¯ä»¥åœ¨æ•´ä¸ªå·¥ä½œæµä¸­ä½¿ç”¨
env:
  # Pythonç‰ˆæœ¬
  PYTHON_VERSION: '3.12'

# å·¥ä½œæµä¸­çš„ä»»åŠ¡å®šä¹‰
jobs:
  # ç¬¬ä¸€ä¸ªä»»åŠ¡ï¼šè¿è¡Œæµ‹è¯•
  test:
    # ä»»åŠ¡åç§°ï¼šæµ‹è¯•
    name: Run Tests

    # è¿è¡Œåœ¨æœ€æ–°çš„Ubuntuç³»ç»Ÿä¸Š
    runs-on: ubuntu-latest

    # å®šä¹‰æœåŠ¡å®¹å™¨ï¼ˆç±»ä¼¼äºDocker Composeä¸­çš„æœåŠ¡ï¼‰
    services:

      # RedisæœåŠ¡
      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    # ä»»åŠ¡çš„å…·ä½“æ­¥éª¤
    steps:
    # æ­¥éª¤1ï¼šæ£€å‡ºä»£ç ï¼ˆæŠŠä»“åº“ä»£ç ä¸‹è½½åˆ°è¿è¡Œç¯å¢ƒï¼‰
    - name: Checkout code
      uses: actions/checkout@v4  # ä½¿ç”¨å®˜æ–¹checkoutåŠ¨ä½œ

    # æ­¥éª¤2ï¼šè®¾ç½®Pythonç¯å¢ƒ
    - name: Set up Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    # æ­¥éª¤3ï¼šå®‰è£…ç³»ç»Ÿä¾èµ–ï¼ˆå¦‚æœéœ€è¦ç¼–è¯‘PythonåŒ…ï¼‰
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libpq-dev python3-dev

    # æ­¥éª¤4ï¼šå®‰è£…Pythonä¾èµ–
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        # å®‰è£…é¡¹ç›®ä¾èµ–
        pip install -r requirements.txt
        # å®‰è£…æµ‹è¯•éœ€è¦çš„é¢å¤–åŒ…
        pip install coverage pytest pytest-django pytest-cov uwsgi

#    # æ­¥éª¤5ï¼šåº”ç”¨æ•°æ®åº“è¿ç§»
#    - name: Run database migrations
#      run: python manage.py migrate
#      env:
#        # è®¾ç½®Djangoéœ€è¦çš„ç¯å¢ƒå˜é‡
#        DJANGO_SETTINGS_MODULE: core.settings
#        DEBUG: 'False'
#        SECRET_KEY: 'dummy-secret-key-for-testing'

    # æ­¥éª¤6ï¼šè¿è¡Œæµ‹è¯•å¹¶ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
    - name: Run tests with coverage
      run: |
        # è¿è¡Œæµ‹è¯•å¹¶æ”¶é›†è¦†ç›–ç‡æ•°æ®
        coverage run --source='.' manage.py test
        # ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
        coverage report
        # ç”ŸæˆHTMLæ ¼å¼çš„è¦†ç›–ç‡æŠ¥å‘Šï¼ˆå¯é€‰ï¼‰
        coverage html
      env:
        DJANGO_SETTINGS_MODULE: core.settings
        DEBUG: 'False'
        SECRET_KEY: 'dummy-secret-key-for-testing'

    # æ­¥éª¤7ï¼šè¿è¡Œä»£ç è´¨é‡æ£€æŸ¥
    - name: Code quality checks
      run: |
        # å®‰è£…ä»£ç è´¨é‡å·¥å…·
        pip install flake8 black isort
        # æ£€æŸ¥ä»£ç é£æ ¼ï¼ˆFlake8ï¼‰
        echo "Running flake8..."
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
        # æ£€æŸ¥ä»£ç æ ¼å¼ï¼ˆBlackï¼‰
        echo "Running black..."
        black . --check
        # æ£€æŸ¥å¯¼å…¥æ’åºï¼ˆisortï¼‰
        echo "Running isort..."
        isort . --check-only


  # ç¬¬äºŒä¸ªä»»åŠ¡ï¼šæ„å»ºå’Œéƒ¨ç½²ï¼ˆåªæœ‰åœ¨æµ‹è¯•é€šè¿‡ä¸”æ˜¯mainåˆ†æ”¯æ—¶æ‰è¿è¡Œï¼‰
  deploy:
    # ä»»åŠ¡åç§°ï¼šéƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
    name: Deploy to Production

    # è¿è¡Œç¯å¢ƒ
    runs-on: ubuntu-latest

    # è¿™ä¸ªä»»åŠ¡ä¾èµ–äºtestä»»åŠ¡ï¼Œåªæœ‰testä»»åŠ¡æˆåŠŸæ‰ä¼šè¿è¡Œ
    needs: test

    # åªæœ‰åœ¨æ¨é€åˆ°mainåˆ†æ”¯æ—¶æ‰è¿è¡Œéƒ¨ç½²
    if: github.ref == 'refs/heads/main'

    steps:
    # æ­¥éª¤1ï¼šæ£€å‡ºä»£ç 
    - name: Checkout code
      uses: actions/checkout@v4

    # æ­¥éª¤2ï¼šè®¾ç½®Dockeræ„å»ºç¯å¢ƒ
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2

    # æ­¥éª¤3ï¼šç™»å½•åˆ°Docker Hubï¼ˆå¦‚æœä½ ä½¿ç”¨Docker Hubï¼‰
    - name: Login to Docker Hub
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    # æ­¥éª¤4ï¼šæ„å»ºå’Œæ¨é€Dockeré•œåƒ
    - name: Build and push Docker images
      uses: docker/build-push-action@v4
      with:
        context: .
        push: true
        tags: |
          ${{ secrets.DOCKERHUB_USERNAME }}/crypto-dashboard:latest

    # æ­¥éª¤5ï¼šéƒ¨ç½²åˆ°æœåŠ¡å™¨ï¼ˆé€šè¿‡SSHï¼‰
    - name: Deploy to server
      uses: appleboy/ssh-action@master
      with:
        # ä»GitHub Secretsä¸­è·å–æœåŠ¡å™¨ä¿¡æ¯
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        # åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œçš„å‘½ä»¤
        script: |
          echo "å¼€å§‹éƒ¨ç½²åŠ å¯†è´§å¸ä»ªè¡¨æ¿..."

          # è¿›å…¥é¡¹ç›®ç›®å½•
          cd /usr/local/crypto-dashboard

          # æ‹‰å–æœ€æ–°çš„Dockeré•œåƒ
          docker pull ${{ secrets.DOCKERHUB_USERNAME }}/crypto-dashboard:latest

          # åœæ­¢å¹¶åˆ é™¤æ—§å®¹å™¨
          docker-compose down

          # å¯åŠ¨æ–°å®¹å™¨
          docker-compose up -d

          echo "éƒ¨ç½²å®Œæˆï¼"    # æ­¥éª¤5ï¼šéƒ¨ç½²åˆ°æœåŠ¡å™¨ï¼ˆé€šè¿‡SSHï¼‰

        # åœ¨å·¥ä½œæµæœ«å°¾æ·»åŠ é€šçŸ¥
        - name: Notify on success
          if: success()
          uses: actions/github-script@v6
          with:
            script: |
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: 'ğŸ‰ éƒ¨ç½²æˆåŠŸï¼æ–°ç‰ˆæœ¬å·²ä¸Šçº¿ã€‚'
              })